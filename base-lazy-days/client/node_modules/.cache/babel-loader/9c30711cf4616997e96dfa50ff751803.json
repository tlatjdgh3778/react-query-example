{"ast":null,"code":"var __read = this && this.__read || function (o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o),\n    r,\n    ar = [],\n    e;\n  try {\n    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\n  } catch (error) {\n    e = {\n      error: error\n    };\n  } finally {\n    try {\n      if (r && !r.done && (m = i[\"return\"])) m.call(i);\n    } finally {\n      if (e) throw e.error;\n    }\n  }\n  return ar;\n};\nvar __spreadArray = this && this.__spreadArray || function (to, from) {\n  for (var i = 0, il = from.length, j = to.length; i < il; i++, j++) to[j] = from[i];\n  return to;\n};\nimport { isArray, isEmptyObject, isMap, isPlainObject, isPrimitive, isSet } from './is';\nimport { escapeKey, stringifyPath } from './pathstringifier';\nimport { isInstanceOfRegisteredClass, transformValue, untransformValue } from './transformer';\nimport { includes, forEach } from './util';\nimport { parsePath } from './pathstringifier';\nimport { getDeep, setDeep } from './accessDeep';\nfunction traverse(tree, walker, origin) {\n  if (origin === void 0) {\n    origin = [];\n  }\n  if (!tree) {\n    return;\n  }\n  if (!isArray(tree)) {\n    forEach(tree, function (subtree, key) {\n      return traverse(subtree, walker, __spreadArray(__spreadArray([], __read(origin)), __read(parsePath(key))));\n    });\n    return;\n  }\n  var _a = __read(tree, 2),\n    nodeValue = _a[0],\n    children = _a[1];\n  if (children) {\n    forEach(children, function (child, key) {\n      traverse(child, walker, __spreadArray(__spreadArray([], __read(origin)), __read(parsePath(key))));\n    });\n  }\n  walker(nodeValue, origin);\n}\nexport function applyValueAnnotations(plain, annotations, superJson) {\n  traverse(annotations, function (type, path) {\n    plain = setDeep(plain, path, function (v) {\n      return untransformValue(v, type, superJson);\n    });\n  });\n  return plain;\n}\nexport function applyReferentialEqualityAnnotations(plain, annotations) {\n  function apply(identicalPaths, path) {\n    var object = getDeep(plain, parsePath(path));\n    identicalPaths.map(parsePath).forEach(function (identicalObjectPath) {\n      plain = setDeep(plain, identicalObjectPath, function () {\n        return object;\n      });\n    });\n  }\n  if (isArray(annotations)) {\n    var _a = __read(annotations, 2),\n      root = _a[0],\n      other = _a[1];\n    root.forEach(function (identicalPath) {\n      plain = setDeep(plain, parsePath(identicalPath), function () {\n        return plain;\n      });\n    });\n    if (other) {\n      forEach(other, apply);\n    }\n  } else {\n    forEach(annotations, apply);\n  }\n  return plain;\n}\nvar isDeep = function (object, superJson) {\n  return isPlainObject(object) || isArray(object) || isMap(object) || isSet(object) || isInstanceOfRegisteredClass(object, superJson);\n};\nfunction addIdentity(object, path, identities) {\n  var existingSet = identities.get(object);\n  if (existingSet) {\n    existingSet.push(path);\n  } else {\n    identities.set(object, [path]);\n  }\n}\nexport function generateReferentialEqualityAnnotations(identitites) {\n  var result = {};\n  var rootEqualityPaths = undefined;\n  identitites.forEach(function (paths) {\n    if (paths.length <= 1) {\n      return;\n    }\n    var _a = __read(paths.map(function (path) {\n        return path.map(String);\n      }).sort(function (a, b) {\n        return a.length - b.length;\n      })),\n      shortestPath = _a[0],\n      identicalPaths = _a.slice(1);\n    if (shortestPath.length === 0) {\n      rootEqualityPaths = identicalPaths.map(stringifyPath);\n    } else {\n      result[stringifyPath(shortestPath)] = identicalPaths.map(stringifyPath);\n    }\n  });\n  if (rootEqualityPaths) {\n    if (isEmptyObject(result)) {\n      return [rootEqualityPaths];\n    } else {\n      return [rootEqualityPaths, result];\n    }\n  } else {\n    return isEmptyObject(result) ? undefined : result;\n  }\n}\nexport var walker = function (object, identities, superJson, path, objectsInThisPath) {\n  var _a;\n  if (path === void 0) {\n    path = [];\n  }\n  if (objectsInThisPath === void 0) {\n    objectsInThisPath = [];\n  }\n  if (!isPrimitive(object)) {\n    addIdentity(object, path, identities);\n  }\n  if (!isDeep(object, superJson)) {\n    var transformed_1 = transformValue(object, superJson);\n    if (transformed_1) {\n      return {\n        transformedValue: transformed_1.value,\n        annotations: [transformed_1.type]\n      };\n    } else {\n      return {\n        transformedValue: object\n      };\n    }\n  }\n  if (includes(objectsInThisPath, object)) {\n    return {\n      transformedValue: null\n    };\n  }\n  var transformationResult = transformValue(object, superJson);\n  var transformed = (_a = transformationResult === null || transformationResult === void 0 ? void 0 : transformationResult.value) !== null && _a !== void 0 ? _a : object;\n  if (!isPrimitive(object)) {\n    objectsInThisPath = __spreadArray(__spreadArray([], __read(objectsInThisPath)), [object]);\n  }\n  var transformedValue = isArray(transformed) ? [] : {};\n  var innerAnnotations = {};\n  forEach(transformed, function (value, index) {\n    var recursiveResult = walker(value, identities, superJson, __spreadArray(__spreadArray([], __read(path)), [index]), objectsInThisPath);\n    transformedValue[index] = recursiveResult.transformedValue;\n    if (isArray(recursiveResult.annotations)) {\n      innerAnnotations[index] = recursiveResult.annotations;\n    } else if (isPlainObject(recursiveResult.annotations)) {\n      forEach(recursiveResult.annotations, function (tree, key) {\n        innerAnnotations[escapeKey(index) + '.' + key] = tree;\n      });\n    }\n  });\n  if (isEmptyObject(innerAnnotations)) {\n    return {\n      transformedValue: transformedValue,\n      annotations: !!transformationResult ? [transformationResult.type] : undefined\n    };\n  } else {\n    return {\n      transformedValue: transformedValue,\n      annotations: !!transformationResult ? [transformationResult.type, innerAnnotations] : innerAnnotations\n    };\n  }\n};","map":{"version":3,"mappings":"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","names":["isArray","isEmptyObject","isMap","isPlainObject","isPrimitive","isSet","escapeKey","stringifyPath","isInstanceOfRegisteredClass","transformValue","untransformValue","includes","forEach","parsePath","getDeep","setDeep","traverse","tree","walker","origin","subtree","key","nodeValue","children","child","applyValueAnnotations","plain","annotations","superJson","type","path","v","applyReferentialEqualityAnnotations","apply","identicalPaths","object","map","identicalObjectPath","root","other","identicalPath","isDeep","addIdentity","identities","existingSet","get","push","set","generateReferentialEqualityAnnotations","identitites","result","rootEqualityPaths","undefined","paths","length","String","sort","a","b","shortestPath","objectsInThisPath","transformed_1","transformedValue","value","transformationResult","transformed","innerAnnotations","index","recursiveResult"],"sourceRoot":"","sources":["../../src/plainer.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}